"use strict";
/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const remapping_1 = __importDefault(require("@ampproject/remapping"));
const terser_1 = require("terser");
const esbuild_executor_1 = require("./esbuild-executor");
/**
 * The cached esbuild executor.
 * This will automatically use the native or WASM version based on platform and availability
 * with the native version given priority due to its superior performance.
 */
let esbuild;
/**
 * Handles optimization requests sent from the main thread via the `JavaScriptOptimizerPlugin`.
 */
async function default_1({ asset, options }) {
    // esbuild is used as a first pass
    const esbuildResult = await optimizeWithEsbuild(asset.code, asset.name, options);
    // terser is used as a second pass
    const terserResult = await optimizeWithTerser(asset.name, esbuildResult.code, options.sourcemap, 
    // Terser only supports up to ES2020.
    options.target === 'next' ? 2020 : options.target, options.advanced);
    // Merge intermediate sourcemaps with input sourcemap if enabled
    let fullSourcemap;
    if (options.sourcemap) {
        const partialSourcemaps = [];
        if (esbuildResult.map) {
            partialSourcemaps.unshift(JSON.parse(esbuildResult.map));
        }
        if (terserResult.map) {
            partialSourcemaps.unshift(terserResult.map);
        }
        if (asset.map) {
            partialSourcemaps.push(asset.map);
        }
        fullSourcemap = (0, remapping_1.default)(partialSourcemaps, () => null);
    }
    return { name: asset.name, code: terserResult.code, map: fullSourcemap };
}
exports.default = default_1;
/**
 * Optimizes a JavaScript asset using esbuild.
 *
 * @param content The JavaScript asset source content to optimize.
 * @param name The name of the JavaScript asset. Used to generate source maps.
 * @param options The optimization request options to apply to the content.
 * @returns A promise that resolves with the optimized code, source map, and any warnings.
 */
async function optimizeWithEsbuild(content, name, options) {
    if (!esbuild) {
        esbuild = new esbuild_executor_1.EsbuildExecutor(options.alwaysUseWasm);
    }
    return esbuild.transform(content, {
        minifyIdentifiers: !options.keepIdentifierNames,
        minifySyntax: true,
        // NOTE: Disabling whitespace ensures unused pure annotations are kept
        minifyWhitespace: false,
        pure: ['forwardRef'],
        legalComments: options.removeLicenses ? 'none' : 'inline',
        sourcefile: name,
        sourcemap: options.sourcemap && 'external',
        define: options.define,
        // This option should always be disabled for browser builds as we don't rely on `.name`
        // and causes deadcode to be retained which makes `NG_BUILD_MANGLE` unusable to investigate tree-shaking issues.
        // We enable `keepNames` only for server builds as Domino relies on `.name`.
        // Once we no longer rely on Domino for SSR we should be able to remove this.
        keepNames: options.keepNames,
        target: `es${options.target}`,
    });
}
/**
 * Optimizes a JavaScript asset using terser.
 *
 * @param name The name of the JavaScript asset. Used to generate source maps.
 * @param code The JavaScript asset source content to optimize.
 * @param sourcemaps If true, generate an output source map for the optimized code.
 * @param target Specifies the target ECMAScript version for the output code.
 * @param advanced Controls advanced optimizations.
 * @returns A promise that resolves with the optimized code and source map.
 */
async function optimizeWithTerser(name, code, sourcemaps, target, advanced) {
    const result = await (0, terser_1.minify)({ [name]: code }, {
        compress: {
            passes: advanced ? 2 : 1,
            pure_getters: advanced,
        },
        ecma: target,
        // esbuild in the first pass is used to minify identifiers instead of mangle here
        mangle: false,
        // esbuild in the first pass is used to minify function names
        keep_fnames: true,
        format: {
            // ASCII output is enabled here as well to prevent terser from converting back to UTF-8
            ascii_only: true,
            wrap_func_args: false,
        },
        sourceMap: sourcemaps &&
            {
                asObject: true,
                // typings don't include asObject option
                // eslint-disable-next-line @typescript-eslint/no-explicit-any
            },
    });
    if (!result.code) {
        throw new Error('Terser failed for unknown reason.');
    }
    return { code: result.code, map: result.map };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiamF2YXNjcmlwdC1vcHRpbWl6ZXItd29ya2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvYW5ndWxhcl9kZXZraXQvYnVpbGRfYW5ndWxhci9zcmMvd2VicGFjay9wbHVnaW5zL2phdmFzY3JpcHQtb3B0aW1pemVyLXdvcmtlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7OztHQU1HOzs7OztBQUVILHNFQUE4QztBQUU5QyxtQ0FBZ0M7QUFDaEMseURBQXFEO0FBNkVyRDs7OztHQUlHO0FBQ0gsSUFBSSxPQUFvQyxDQUFDO0FBRXpDOztHQUVHO0FBQ1ksS0FBSyxvQkFBVyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQW1CO0lBQ2hFLGtDQUFrQztJQUNsQyxNQUFNLGFBQWEsR0FBRyxNQUFNLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztJQUVqRixrQ0FBa0M7SUFDbEMsTUFBTSxZQUFZLEdBQUcsTUFBTSxrQkFBa0IsQ0FDM0MsS0FBSyxDQUFDLElBQUksRUFDVixhQUFhLENBQUMsSUFBSSxFQUNsQixPQUFPLENBQUMsU0FBUztJQUNqQixxQ0FBcUM7SUFDckMsT0FBTyxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFDakQsT0FBTyxDQUFDLFFBQVEsQ0FDakIsQ0FBQztJQUVGLGdFQUFnRTtJQUNoRSxJQUFJLGFBQWEsQ0FBQztJQUNsQixJQUFJLE9BQU8sQ0FBQyxTQUFTLEVBQUU7UUFDckIsTUFBTSxpQkFBaUIsR0FBRyxFQUFFLENBQUM7UUFFN0IsSUFBSSxhQUFhLENBQUMsR0FBRyxFQUFFO1lBQ3JCLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxHQUFH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aWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQgcmVtYXBwaW5nIGZyb20gJ0BhbXBwcm9qZWN0L3JlbWFwcGluZyc7XG5pbXBvcnQgdHlwZSB7IFRyYW5zZm9ybVJlc3VsdCB9IGZyb20gJ2VzYnVpbGQnO1xuaW1wb3J0IHsgbWluaWZ5IH0gZnJvbSAndGVyc2VyJztcbmltcG9ydCB7IEVzYnVpbGRFeGVjdXRvciB9IGZyb20gJy4vZXNidWlsZC1leGVjdXRvcic7XG5cbi8qKlxuICogVGhlIG9wdGlvbnMgdG8gdXNlIHdoZW4gb3B0aW1pemluZy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBPcHRpbWl6ZVJlcXVlc3RPcHRpb25zIHtcbiAgLyoqXG4gICAqIENvbnRyb2xzIGFkdmFuY2VkIG9wdGltaXphdGlvbnMuXG4gICAqIEN1cnJlbnRseSB0aGVzZSBhcmUgb25seSB0ZXJzZXIgcmVsYXRlZDpcbiAgICogKiB0ZXJzZXIgY29tcHJlc3MgcGFzc2VzIGFyZSBzZXQgdG8gMlxuICAgKiAqIHRlcnNlciBwdXJlX2dldHRlcnMgb3B0aW9uIGlzIGVuYWJsZWRcbiAgICovXG4gIGFkdmFuY2VkPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFNwZWNpZmllcyB0aGUgc3RyaW5nIHRva2VucyB0aGF0IHNob3VsZCBiZSByZXBsYWNlZCB3aXRoIGEgZGVmaW5lZCB2YWx1ZS5cbiAgICovXG4gIGRlZmluZT86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG4gIC8qKlxuICAgKiBDb250cm9scyB3aGV0aGVyIGNsYXNzLCBmdW5jdGlvbiwgYW5kIHZhcmlhYmxlIG5hbWVzIHNob3VsZCBiZSBsZWZ0IGludGFjdFxuICAgKiB0aHJvdWdob3V0IHRoZSBvdXRwdXQgY29kZS5cbiAgICovXG4gIGtlZXBJZGVudGlmaWVyTmFtZXM6IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIENvbnRyb2xzIHdoZXRoZXIgdG8gcmV0YWluIHRoZSBvcmlnaW5hbCBuYW1lIG9mIGNsYXNzZXMgYW5kIGZ1bmN0aW9ucy5cbiAgICovXG4gIGtlZXBOYW1lczogYm9vbGVhbjtcbiAgLyoqXG4gICAqIENvbnRyb2xzIHdoZXRoZXIgbGljZW5zZSB0ZXh0IGlzIHJlbW92ZWQgZnJvbSB0aGUgb3V0cHV0IGNvZGUuXG4gICAqIFdpdGhpbiB0aGUgQ0xJLCB0aGlzIG9wdGlvbiBpcyBsaW5rZWQgdG8gdGhlIGxpY2Vuc2UgZXh0cmFjdGlvbiBmdW5jdGlvbmFsaXR5LlxuICAgKi9cbiAgcmVtb3ZlTGljZW5zZXM/OiBib29sZWFuO1xuICAvKipcbiAgICogQ29udHJvbHMgd2hldGhlciBzb3VyY2UgbWFwcyBzaG91bGQgYmUgZ2VuZXJhdGVkLlxuICAgKi9cbiAgc291cmNlbWFwPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFNwZWNpZmllcyB0aGUgdGFyZ2V0IEVDTUFTY3JpcHQgdmVyc2lvbiBmb3IgdGhlIG91dHB1dCBjb2RlLlxuICAgKi9cbiAgdGFyZ2V0OiA1IHwgMjAxNSB8IDIwMTYgfCAyMDE3IHwgMjAxOCB8IDIwMTkgfCAyMDIwIHwgJ25leHQnO1xuICAvKipcbiAgICogQ29udHJvbHMgd2hldGhlciBlc2J1aWxkIHNob3VsZCBvbmx5IHVzZSB0aGUgV0FTTS12YXJpYW50IGluc3RlYWQgb2YgdHJ5aW5nIHRvXG4gICAqIHVzZSB0aGUgbmF0aXZlIHZhcmlhbnQuIFNvbWUgcGxhdGZvcm1zIG1heSBub3Qgc3VwcG9ydCB0aGUgbmF0aXZlLXZhcmlhbnQgYW5kXG4gICAqIHRoaXMgb3B0aW9uIGFsbG93cyBvbmUgc3VwcG9ydCB0ZXN0IHRvIGJlIGNvbmR1Y3RlZCBwcmlvciB0byBhbGwgdGhlIHdvcmtlcnMgc3RhcnRpbmcuXG4gICAqL1xuICBhbHdheXNVc2VXYXNtOiBib29sZWFuO1xufVxuXG4vKipcbiAqIEEgcmVxdWVzdCB0byBvcHRpbWl6ZSBKYXZhU2NyaXB0IHVzaW5nIHRoZSBzdXBwbGllZCBvcHRpb25zLlxuICovXG5pbnRlcmZhY2UgT3B0aW1pemVSZXF1ZXN0IHtcbiAgLyoqXG4gICAqIFRoZSBvcHRpb25zIHRvIHVzZSB3aGVuIG9wdGltaXppbmcuXG4gICAqL1xuICBvcHRpb25zOiBPcHRpbWl6ZVJlcXVlc3RPcHRpb25zO1xuXG4gIC8qKlxuICAgKiBUaGUgSmF2YVNjcmlwdCBhc3NldCB0byBvcHRpbWl6ZS5cbiAgICovXG4gIGFzc2V0OiB7XG4gICAgLyoqXG4gICAgICogVGhlIG5hbWUgb2YgdGhlIEphdmFTY3JpcHQgYXNzZXQgKHR5cGljYWxseSB0aGUgZmlsZW5hbWUpLlxuICAgICAqL1xuICAgIG5hbWU6IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBUaGUgc291cmNlIGNvbnRlbnQgb2YgdGhlIEphdmFTY3JpcHQgYXNzZXQuXG4gICAgICovXG4gICAgY29kZTogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIFRoZSBzb3VyY2UgbWFwIG9mIHRoZSBKYXZhU2NyaXB0IGFzc2V0LCBpZiBhdmFpbGFibGUuXG4gICAgICogVGhpcyBtYXAgaXMgbWVyZ2VkIHdpdGggYWxsIGludGVybWVkaWF0ZSBzb3VyY2UgbWFwcyBkdXJpbmcgb3B0aW1pemF0aW9uLlxuICAgICAqL1xuICAgIG1hcDogb2JqZWN0O1xuICB9O1xufVxuXG4vKipcbiAqIFRoZSBjYWNoZWQgZXNidWlsZCBleGVjdXRvci5cbiAqIFRoaXMgd2lsbCBhdXRvbWF0aWNhbGx5IHVzZSB0aGUgbmF0aXZlIG9yIFdBU00gdmVyc2lvbiBiYXNlZCBvbiBwbGF0Zm9ybSBhbmQgYXZhaWxhYmlsaXR5XG4gKiB3aXRoIHRoZSBuYXRpdmUgdmVyc2lvbiBnaXZlbiBwcmlvcml0eSBkdWUgdG8gaXRzIHN1cGVyaW9yIHBlcmZvcm1hbmNlLlxuICovXG5sZXQgZXNidWlsZDogRXNidWlsZEV4ZWN1dG9yIHwgdW5kZWZpbmVkO1xuXG4vKipcbiAqIEhhbmRsZXMgb3B0aW1pemF0aW9uIHJlcXVlc3RzIHNlbnQgZnJvbSB0aGUgbWFpbiB0aHJlYWQgdmlhIHRoZSBgSmF2YVNjcmlwdE9wdGltaXplclBsdWdpbmAuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uICh7IGFzc2V0LCBvcHRpb25zIH06IE9wdGltaXplUmVxdWVzdCkge1xuICAvLyBlc2J1aWxkIGlzIHVzZWQgYXMgYSBmaXJzdCBwYXNzXG4gIGNvbnN0IGVzYnVpbGRSZXN1bHQgPSBhd2FpdCBvcHRpbWl6ZVdpdGhFc2J1aWxkKGFzc2V0LmNvZGUsIGFzc2V0Lm5hbWUsIG9wdGlvbnMpO1xuXG4gIC8vIHRlcnNlciBpcyB1c2VkIGFzIGEgc2Vjb25kIHBhc3NcbiAgY29uc3QgdGVyc2VyUmVzdWx0ID0gYXdhaXQgb3B0aW1pemVXaXRoVGVyc2VyKFxuICAgIGFzc2V0Lm5hbWUsXG4gICAgZXNidWlsZFJlc3VsdC5jb2RlLFxuICAgIG9wdGlvbnMuc291cmNlbWFwLFxuICAgIC8vIFRlcnNlciBvbmx5IHN1cHBvcnRzIHVwIHRvIEVTMjAyMC5cbiAgICBvcHRpb25zLnRhcmdldCA9PT0gJ25leHQnID8gMjAyMCA6IG9wdGlvbnMudGFyZ2V0LFxuICAgIG9wdGlvbnMuYWR2YW5jZWQsXG4gICk7XG5cbiAgLy8gTWVyZ2UgaW50ZXJtZWRpYXRlIHNvdXJjZW1hcHMgd2l0aCBpbnB1dCBzb3VyY2VtYXAgaWYgZW5hYmxlZFxuICBsZXQgZnVsbFNvdXJjZW1hcDtcbiAgaWYgKG9wdGlvbnMuc291cmNlbWFwKSB7XG4gICAgY29uc3QgcGFydGlhbFNvdXJjZW1hcHMgPSBbXTtcblxuICAgIGlmIChlc2J1aWxkUmVzdWx0Lm1hcCkge1xuICAgICAgcGFydGlhbFNvdXJjZW1hcHMudW5zaGlmdChKU09OLnBhcnNlKGVzYnVpbGRSZXN1bHQubWFwKSk7XG4gICAgfVxuXG4gICAgaWYgKHRlcnNlclJlc3VsdC5tYXApIHtcbiAgICAgIHBhcnRpYWxTb3VyY2VtYXBzLnVuc2hpZnQodGVyc2VyUmVzdWx0Lm1hcCk7XG4gICAgfVxuXG4gICAgaWYgKGFzc2V0Lm1hcCkge1xuICAgICAgcGFydGlhbFNvdXJjZW1hcHMucHVzaChhc3NldC5tYXApO1xuICAgIH1cblxuICAgIGZ1bGxTb3VyY2VtYXAgPSByZW1hcHBpbmcocGFydGlhbFNvdXJjZW1hcHMsICgpID0+IG51bGwpO1xuICB9XG5cbiAgcmV0dXJuIHsgbmFtZTogYXNzZXQubmFtZSwgY29kZTogdGVyc2VyUmVzdWx0LmNvZGUsIG1hcDogZnVsbFNvdXJjZW1hcCB9O1xufVxuXG4vKipcbiAqIE9wdGltaXplcyBhIEphdmFTY3JpcHQgYXNzZXQgdXNpbmcgZXNidWlsZC5cbiAqXG4gKiBAcGFyYW0gY29udGVudCBUaGUgSmF2YVNjcmlwdCBhc3NldCBzb3VyY2UgY29udGVudCB0byBvcHRpbWl6ZS5cbiAqIEBwYXJhbSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBKYXZhU2NyaXB0IGFzc2V0LiBVc2VkIHRvIGdlbmVyYXRlIHNvdXJjZSBtYXBzLlxuICogQHBhcmFtIG9wdGlvbnMgVGhlIG9wdGltaXphdGlvbiByZXF1ZXN0IG9wdGlvbnMgdG8gYXBwbHkgdG8gdGhlIGNvbnRlbnQuXG4gKiBAcmV0dXJucyBBIHByb21pc2UgdGhhdCByZXNvbHZlcyB3aXRoIHRoZSBvcHRpbWl6ZWQgY29kZSwgc291cmNlIG1hcCwgYW5kIGFueSB3YXJuaW5ncy5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gb3B0aW1pemVXaXRoRXNidWlsZChcbiAgY29udGVudDogc3RyaW5nLFxuICBuYW1lOiBzdHJpbmcsXG4gIG9wdGlvbnM6IE9wdGltaXplUmVxdWVzdFsnb3B0aW9ucyddLFxuKTogUHJvbWlzZTxUcmFuc2Zvcm1SZXN1bHQ+IHtcbiAgaWYgKCFlc2J1aWxkKSB7XG4gICAgZXNidWlsZCA9IG5ldyBFc2J1aWxkRXhlY3V0b3Iob3B0aW9ucy5hbHdheXNVc2VXYXNtKTtcbiAgfVxuXG4gIHJldHVybiBlc2J1aWxkLnRyYW5zZm9ybShjb250ZW50LCB7XG4gICAgbWluaWZ5SWRlbnRpZmllcnM6ICFvcHRpb25zLmtlZXBJZGVudGlmaWVyTmFtZXMsXG4gICAgbWluaWZ5U3ludGF4OiB0cnVlLFxuICAgIC8vIE5PVEU6IERpc2FibGluZyB3aGl0ZXNwYWNlIGVuc3VyZXMgdW51c2VkIHB1cmUgYW5ub3RhdGlvbnMgYXJlIGtlcHRcbiAgICBtaW5pZnlXaGl0ZXNwYWNlOiBmYWxzZSxcbiAgICBwdXJlOiBbJ2ZvcndhcmRSZWYnXSxcbiAgICBsZWdhbENvbW1lbnRzOiBvcHRpb25zLnJlbW92ZUxpY2Vuc2VzID8gJ25vbmUnIDogJ2lubGluZScsXG4gICAgc291cmNlZmlsZTogbmFtZSxcbiAgICBzb3VyY2VtYXA6IG9wdGlvbnMuc291cmNlbWFwICYmICdleHRlcm5hbCcsXG4gICAgZGVmaW5lOiBvcHRpb25zLmRlZmluZSxcbiAgICAvLyBUaGlzIG9wdGlvbiBzaG91bGQgYWx3YXlzIGJlIGRpc2FibGVkIGZvciBicm93c2VyIGJ1aWxkcyBhcyB3ZSBkb24ndCByZWx5IG9uIGAubmFtZWBcbiAgICAvLyBhbmQgY2F1c2VzIGRlYWRjb2RlIHRvIGJlIHJldGFpbmVkIHdoaWNoIG1ha2VzIGBOR19CVUlMRF9NQU5HTEVgIHVudXNhYmxlIHRvIGludmVzdGlnYXRlIHRyZWUtc2hha2luZyBpc3N1ZXMuXG4gICAgLy8gV2UgZW5hYmxlIGBrZWVwTmFtZXNgIG9ubHkgZm9yIHNlcnZlciBidWlsZHMgYXMgRG9taW5vIHJlbGllcyBvbiBgLm5hbWVgLlxuICAgIC8vIE9uY2Ugd2Ugbm8gbG9uZ2VyIHJlbHkgb24gRG9taW5vIGZvciBTU1Igd2Ugc2hvdWxkIGJlIGFibGUgdG8gcmVtb3ZlIHRoaXMuXG4gICAga2VlcE5hbWVzOiBvcHRpb25zLmtlZXBOYW1lcyxcbiAgICB0YXJnZXQ6IGBlcyR7b3B0aW9ucy50YXJnZXR9YCxcbiAgfSk7XG59XG5cbi8qKlxuICogT3B0aW1pemVzIGEgSmF2YVNjcmlwdCBhc3NldCB1c2luZyB0ZXJzZXIuXG4gKlxuICogQHBhcmFtIG5hbWUgVGhlIG5hbWUgb2YgdGhlIEphdmFTY3JpcHQgYXNzZXQuIFVzZWQgdG8gZ2VuZXJhdGUgc291cmNlIG1hcHMuXG4gKiBAcGFyYW0gY29kZSBUaGUgSmF2YVNjcmlwdCBhc3NldCBzb3VyY2UgY29udGVudCB0byBvcHRpbWl6ZS5cbiAqIEBwYXJhbSBzb3VyY2VtYXBzIElmIHRydWUsIGdlbmVyYXRlIGFuIG91dHB1dCBzb3VyY2UgbWFwIGZvciB0aGUgb3B0aW1pemVkIGNvZGUuXG4gKiBAcGFyYW0gdGFyZ2V0IFNwZWNpZmllcyB0aGUgdGFyZ2V0IEVDTUFTY3JpcHQgdmVyc2lvbiBmb3IgdGhlIG91dHB1dCBjb2RlLlxuICogQHBhcmFtIGFkdmFuY2VkIENvbnRyb2xzIGFkdmFuY2VkIG9wdGltaXphdGlvbnMuXG4gKiBAcmV0dXJucyBBIHByb21pc2UgdGhhdCByZXNvbHZlcyB3aXRoIHRoZSBvcHRpbWl6ZWQgY29kZSBhbmQgc291cmNlIG1hcC5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gb3B0aW1pemVXaXRoVGVyc2VyKFxuICBuYW1lOiBzdHJpbmcsXG4gIGNvZGU6IHN0cmluZyxcbiAgc291cmNlbWFwczogYm9vbGVhbiB8IHVuZGVmaW5lZCxcbiAgdGFyZ2V0OiBFeGNsdWRlPE9wdGltaXplUmVxdWVzdFsnb3B0aW9ucyddWyd0YXJnZXQnXSwgJ25leHQnPixcbiAgYWR2YW5jZWQ6IGJvb2xlYW4gfCB1bmRlZmluZWQsXG4pOiBQcm9taXNlPHsgY29kZTogc3RyaW5nOyBtYXA/OiBvYmplY3QgfT4ge1xuICBjb25zdCByZXN1bHQgPSBhd2FpdCBtaW5pZnkoXG4gICAgeyBbbmFtZV06IGNvZGUgfSxcbiAgICB7XG4gICAgICBjb21wcmVzczoge1xuICAgICAgICBwYXNzZXM6IGFkdmFuY2VkID8gMiA6IDEsXG4gICAgICAgIHB1cmVfZ2V0dGVyczogYWR2YW5jZWQsXG4gICAgICB9LFxuICAgICAgZWNtYTogdGFyZ2V0LFxuICAgICAgLy8gZXNidWlsZCBpbiB0aGUgZmlyc3QgcGFzcyBpcyB1c2VkIHRvIG1pbmlmeSBpZGVudGlmaWVycyBpbnN0ZWFkIG9mIG1hbmdsZSBoZXJlXG4gICAgICBtYW5nbGU6IGZhbHNlLFxuICAgICAgLy8gZXNidWlsZCBpbiB0aGUgZmlyc3QgcGFzcyBpcyB1c2VkIHRvIG1pbmlmeSBmdW5jdGlvbiBuYW1lc1xuICAgICAga2VlcF9mbmFtZXM6IHRydWUsXG4gICAgICBmb3JtYXQ6IHtcbiAgICAgICAgLy8gQVNDSUkgb3V0cHV0IGlzIGVuYWJsZWQgaGVyZSBhcyB3ZWxsIHRvIHByZXZlbnQgdGVyc2VyIGZyb20gY29udmVydGluZyBiYWNrIHRvIFVURi04XG4gICAgICAgIGFzY2lpX29ubHk6IHRydWUsXG4gICAgICAgIHdyYXBfZnVuY19hcmdzOiBmYWxzZSxcbiAgICAgIH0sXG4gICAgICBzb3VyY2VNYXA6XG4gICAgICAgIHNvdXJjZW1hcHMgJiZcbiAgICAgICAgKHtcbiAgICAgICAgICBhc09iamVjdDogdHJ1ZSxcbiAgICAgICAgICAvLyB0eXBpbmdzIGRvbid0IGluY2x1ZGUgYXNPYmplY3Qgb3B0aW9uXG4gICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgICAgICAgfSBhcyBhbnkpLFxuICAgIH0sXG4gICk7XG5cbiAgaWYgKCFyZXN1bHQuY29kZSkge1xuICAgIHRocm93IG5ldyBFcnJvcignVGVyc2VyIGZhaWxlZCBmb3IgdW5rbm93biByZWFzb24uJyk7XG4gIH1cblxuICByZXR1cm4geyBjb2RlOiByZXN1bHQuY29kZSwgbWFwOiByZXN1bHQubWFwIGFzIG9iamVjdCB9O1xufVxuIl19